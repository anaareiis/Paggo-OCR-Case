// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // In Prisma v7 the connection URL is configured in prisma.config.ts (not in the schema)
}

//
// ────────────────────────────────────────────────────────────
// USER
// ────────────────────────────────────────────────────────────
//

model User {
  id         String      @id @default(uuid())
  email      String      @unique
  name       String?
  password   String?     // optional for now (Issue 8)
  createdAt  DateTime    @default(now())

  documents  Document[]
  llmHistory LLMInteraction[]  @relation("UserLLMHistory")
}

//
// ────────────────────────────────────────────────────────────
// DOCUMENT
// ────────────────────────────────────────────────────────────
//

model Document {
  id            String       @id @default(uuid())
  originalName  String
  storagePath   String       // uploads/<uuid>.pdf|png|jpg
  mimeType      String
  size          Int
  createdAt     DateTime     @default(now())

  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  ocrResult     OCRResult?
  llmHistory    LLMInteraction[] @relation("DocumentLLMHistory")

  @@index([userId])
}

//
// ────────────────────────────────────────────────────────────
// OCR RESULT
// ────────────────────────────────────────────────────────────
//

model OCRResult {
  id            String     @id @default(uuid())
  documentId    String     @unique
  extractedText String
  ocrMeta       Json?      // can store confidence, detected language, timings, etc.
  extractedAt   DateTime   @default(now())

  document      Document   @relation(fields: [documentId], references: [id], onDelete: Cascade)
}

//
// ────────────────────────────────────────────────────────────
// LLM INTERACTIONS
// ────────────────────────────────────────────────────────────
//

model LLMInteraction {
  id          String   @id @default(uuid())
  userId      String? 
  documentId  String?

  // fields aligned with the backend code (question/answer/rawResponse/provider)
  question    String
  answer      String
  provider    String?    // e.g. "openai" or "mock"
  rawResponse Json?      // raw response or metadata from the provider (JSON)

  createdAt   DateTime   @default(now())

  user        User?      @relation("UserLLMHistory", fields: [userId], references: [id], onDelete: Cascade)
  document    Document?  @relation("DocumentLLMHistory", fields: [documentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([documentId])
}
